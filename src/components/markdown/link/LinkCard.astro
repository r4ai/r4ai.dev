---
import {
  extract,
  hasProvider,
  type OembedData,
} from "@extractus/oembed-extractor"
import { randomUUID } from "crypto"
import { Switch, Case, Default } from "@/components/utils/switch"
import JSFiddle from "./JSFiddle.astro"
import StackBlitz from "./StackBlitz.astro"
import { Twitter } from "./Twitter"

const hasHtml = (oembed: OembedData): oembed is OembedData & { html: string } =>
  oembed !== undefined && "html" in oembed && typeof oembed.html === "string"

const isTwitter = (url: URL) =>
  url.hostname.match(/twitter\.com$/) || url.hostname.match(/x\.com$/)

export type LinkCardProps = JSX.IntrinsicElements["a"] & {
  oembed?: OembedData
  url: URL
}
type Props = LinkCardProps
const props = Astro.props

const url = new URL(props.href ?? "")

let oembedId: string | undefined = undefined

const getOembed = async (url: URL) => {
  if (isTwitter(url)) {
    return undefined
  }
  if (hasProvider(url.href)) {
    const oembed = await extract(url.href)
    if (hasHtml(oembed)) {
      oembedId = randomUUID()
      oembed.html = oembed.html.replace(
        /<blockquote/g,
        `<blockquote data-id="${oembedId}"`
      )
    }
    return oembed
  }
  return undefined
}
props.oembed = await getOembed(url)
---

<style is:global>
  .twitter-tweet {
    margin: 0 auto !important;
  }

  div[data-oembed] > * {
    margin: 0 auto !important;
  }
  div[data-oembed] > div {
    width: fit-content; /* SlideShare */
  }
</style>

{
  props.oembed && hasHtml(props.oembed) ? (
    <div data-oembed set:html={props.oembed.html} />
  ) : (
    <Switch value={url.hostname}>
      <Case slot="jsfiddle.net">
        <JSFiddle url={url} />
      </Case>
      <Case slot="stackblitz.com">
        <StackBlitz url={url} />
      </Case>
      <Case slot="twitter.com">
        <div class="mx-auto w-full sm:w-[80%]">
          <Twitter url={url} client:load />
        </div>
      </Case>
      <Default>
        {/* eslint-disable-next-line */}
        <a {...(props as any)}>
          <slot />
        </a>
      </Default>
    </Switch>
  )
}

{
  oembedId && (
    <script is:inline define:vars={{ id: oembedId }}>
      const oembed = document.querySelector(`[data-id="${id}"]`)
      oembed?.setAttribute("data-theme", resolvedTheme)
      oembed?.setAttribute("data-embed-theme", resolvedTheme)
    </script>
  )
}
